{namespace ms=Mcplamen\Monthlyschedule\ViewHelpers}

<f:layout name="Default" />
<f:asset.css identifier="calendar-css" href="EXT:monthlyschedule/Resources/Public/Css/calendar.css" />

<f:section name="content">

<div class="calendar-wrapper public-booking">
    <h1 class="main-title">Book an Appointment</h1>
    <p class="subtitle">Select a date and time slot to book your appointment</p>

    <ms:calendar month="{currentMonth}" year="{currentYear}" days="{currentDays}">
        <div class="month-header">
            <h2>{monthName} {year}</h2>
        </div>

        <table class="calendar-table">
            <thead>
                <tr>
                    <th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th>
                    <th class="weekend">Sa</th><th class="weekend">So</th>
                </tr>
            </thead>
            <tbody>
                <f:for each="{calendar}" as="week">
                    <tr>
                        <f:for each="{week}" as="cell">
                            <td class="
                                {f:if(condition: cell.hasData, then: 'has-data')}
                                {f:if(condition: cell.isToday, then: ' today')}
                                {f:if(condition: cell.isWeekend, then: ' weekend')}
                                {f:if(condition: '{cell.day} == 0', then: ' empty')}
                            ">
                                <f:if condition="{cell.day}">
                                    <div class="day-cell">
                                        <span class="day-number">{cell.day}</span>

                                        <f:if condition="{cell.hasData}">
                                            <div class="events-list">
                                                <f:for each="{cell.dayEvents}" as="event">
                                                    <a href="#"
                                                       class="event-link {f:if(condition: event.person, then: 'booked', else: 'available')}"
                                                       data-myday-uid="{event.uid}">
                                                        <span class="event-time">
                                                            {event.timeslot} â€“ {event.timeslotend}
                                                        </span>
                                                        <span class="event-status">
                                                            <f:if condition="{event.person}">
                                                                ðŸ”’ Booked
                                                            <f:else>
                                                                âœ“ Available
                                                            </f:else>
                                                            </f:if>
                                                        </span>
                                                    </a>
                                                </f:for>
                                            </div>
                                        </f:if>
                                    </div>
                                </f:if>
                            </td>
                        </f:for>
                    </tr>
                </f:for>
            </tbody>
        </table>
    </ms:calendar>
</div>



<!-- ================= SCRIPT ================= -->

<script>
// Open modal function (Bootstrap 4 compatible)
function openEventModal(mydayUid) {
    console.log('Opening modal for UID:', mydayUid);
    
    // Get modal element
    var modalEl = document.getElementById('eventModal');
    var modalBody = document.getElementById('modalBody');
    
    // Show modal
    var $modal = window.jQuery ? jQuery(modalEl) : null;
    if ($modal) {
        $modal.modal('show');
    } else {
        modalEl.classList.add('show');
        modalEl.style.display = 'block';
        document.body.classList.add('modal-open');
        
        var backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'modalBackdrop';
        document.body.appendChild(backdrop);
    }
    
    // Show loading spinner
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>';
    
    // Build URL
    var url = window.location.pathname + 
        '?tx_monthlyschedule_publicbooking[action]=ajaxShow' +
        '&tx_monthlyschedule_monthlyschedule[controller]=Myday' +
        '&tx_monthlyschedule_monthlyschedule[myday]=' + mydayUid;
    
    console.log('AJAX URL:', url);
    
	// Fetch data
	fetch(url)
		.then(response => response.text())
		.then(html => {
			console.log('AJAX success, content length:', html.length);
			console.log('First 500 chars of HTML:', html.substring(0, 500));
			console.log('Contains <html> tag?', html.indexOf('<html') !== -1);
			console.log('Contains event-details?', html.indexOf('event-details') !== -1);
			
			modalBody.innerHTML = html;
		})
		.catch(error => {
			console.error('AJAX error:', error);
			modalBody.innerHTML = '<div class="alert alert-danger">Error loading event details: ' + error + '</div>';
		});
}

// Event delegation when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    
    // Handle clicks on event links
    document.addEventListener('click', function(e) {
        var target = e.target.closest('.event-link');
        if (target && target.hasAttribute('data-myday-uid')) {
            e.preventDefault();
            var mydayUid = target.getAttribute('data-myday-uid');
            openEventModal(mydayUid);
        }
    });
    
    // Handle booking form submission with event delegation
    document.addEventListener('submit', function(e) {
        if (e.target && e.target.id === 'bookingForm') {
            e.preventDefault();
            
            console.log('Booking form submitted via delegation');
            
            var form = e.target;
            var mydayUid = form.getAttribute('data-myday-uid');
            var submitBtn = form.querySelector('button[type="submit"]');
            
            var formData = {
                person: form.querySelector('[name="person"]').value,
                email: form.querySelector('[name="email"]').value,
                topic: form.querySelector('[name="topic"]').value
            };
            
            console.log('Booking data:', formData);
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Booking...';
            
            // Build POST data
            var postData = new URLSearchParams();
			postData.append('tx_monthlyschedule_publicbooking[action]', 'publicBook');  // ÐŸÐ ÐžÐœÐ•ÐÐ•ÐÐž
			postData.append('tx_monthlyschedule_publicbooking[controller]', 'Myday');   // ÐŸÐ ÐžÐœÐ•ÐÐ•ÐÐž
			postData.append('tx_monthlyschedule_publicbooking[myday]', mydayUid); 
            postData.append('tx_monthlyschedule_monthlyschedule[data][person]', formData.person);
            postData.append('tx_monthlyschedule_monthlyschedule[data][email]', formData.email);
            postData.append('tx_monthlyschedule_monthlyschedule[data][topic]', formData.topic);
            
            console.log('POST data:', postData.toString());
            
            // AJAX save
            fetch(window.location.pathname, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: postData
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.text();
            })
            .then(text => {
                console.log('Raw response:', text);
                
                try {
                    var data = JSON.parse(text);
                    console.log('Parsed data:', data);
                    
                    if(data.success) {
                        // Replace modal body with success message
                        var modalBody = document.getElementById('modalBody');
                        modalBody.innerHTML = '<div class="alert alert-success text-center"><h4>âœ“ Saved Successfully!</h4><p>Your appointment has been booked.</p><p>We will contact you soon at <strong>' + formData.email + '</strong></p></div>';
                        
                        // Close modal after 3 seconds and reload
                        setTimeout(function() {
                            var modalEl = document.getElementById('eventModal');
                            if (window.jQuery) {
                                jQuery(modalEl).modal('hide');
                            }
                            location.reload();
                        }, 3000);
                    } else {
                        // Show error
                        var errorDiv = document.createElement('div');
                        errorDiv.className = 'alert alert-danger';
                        errorDiv.textContent = 'Error: ' + (data.message || 'Unknown error');
                        form.insertBefore(errorDiv, form.firstChild);
                        
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Book this time slot';
                    }
                } catch(err) {
                    console.error('JSON parse error:', err);
                    
                    var errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger';
                    errorDiv.textContent = 'Server error: Invalid response';
                    form.insertBefore(errorDiv, form.firstChild);
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Book this time slot';
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                
                var errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.textContent = 'Error: ' + error;
                form.insertBefore(errorDiv, form.firstChild);
                
                submitBtn.disabled = false;
                submitBtn.textContent = 'Book this time slot';
            });
        }
    });
});
</script>

<!-- Bootstrap Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Book Appointment</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

</f:section>
