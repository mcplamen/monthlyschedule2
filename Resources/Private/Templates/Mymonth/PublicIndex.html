{namespace ms=Mcplamen\Monthlyschedule\ViewHelpers}

<f:layout name="Default" />
<f:asset.css identifier="calendar-css" href="EXT:monthlyschedule/Resources/Public/Css/calendar.css" />

<f:section name="content">

    <div class="calendar-wrapper public-booking">
        <h1 class="main-title">Book an Appointment</h1>
        <p class="subtitle">Select a date and time slot to book your appointment</p>
        
        <!-- Ð¢ÐµÐºÑƒÑ‰ Ð¼ÐµÑÐµÑ† -->
        <f:if condition="{currentMymonth}">
            <f:then>
                <ms:calendar month="{currentMonth}" year="{currentYear}" days="{currentDays}">
                    <div class="month-header">
                        <h2>{monthName} {year}</h2>
                    </div>
                    
                    <table class="calendar-table">
                        <thead>
                            <tr>
                                <th>Mo</th>
                                <th>Di</th>
                                <th>Mi</th>
                                <th>Do</th>
                                <th>Fr</th>
                                <th class="weekend">Sa</th>
                                <th class="weekend">So</th>
                            </tr>
                        </thead>
                        <tbody>
                            <f:for each="{calendar}" as="week">
                                <tr>
                                    <f:for each="{week}" as="cell">
                                        <td class="
                                            {f:if(condition: cell.hasData, then: 'has-data')}
                                            {f:if(condition: cell.isToday, then: ' today')}
                                            {f:if(condition: cell.isWeekend, then: ' weekend')}
                                            {f:if(condition: '{cell.day} == 0', then: ' empty')}
                                        ">
                                            <f:if condition="{cell.day}">
                                                <f:then>
                                                    <div class="day-cell">
                                                        <span class="day-number">{cell.day}</span>
                                                        
                                                        <f:if condition="{cell.hasData}">
                                                            <div class="events-list">
                                                                <f:for each="{cell.dayEvents}" as="event">
                                                                    <a href="#" 
                                                                       data-myday-uid="{event.uid}"
                                                                       class="event-link {f:if(condition: event.person, then: 'booked', else: 'available')}"
                                                                       title="{f:if(condition: event.person, then: 'Booked', else: 'Click to book')}">
                                                                        <span class="event-time">
                                                                            <f:if condition="{event.timeslot}">
                                                                                {event.timeslot}
                                                                            </f:if>
                                                                            <f:if condition="{event.timeslotend}">
                                                                                - {event.timeslotend}
                                                                            </f:if>
                                                                        </span>
                                                                        <span class="event-status">
                                                                            <f:if condition="{event.person}">
                                                                                <f:then>ðŸ”’ Booked</f:then>
                                                                                <f:else>âœ“ Available</f:else>
                                                                            </f:if>
                                                                        </span>
                                                                    </a>
                                                                </f:for>
                                                            </div>
                                                        </f:if>
                                                    </div>
                                                </f:then>
                                                <f:else>
                                                    <span class="empty-cell">&nbsp;</span>
                                                </f:else>
                                            </f:if>
                                        </td>
                                    </f:for>
                                </tr>
                            </f:for>
                        </tbody>
                    </table>
                </ms:calendar>
            </f:then>
            <f:else>
                <p class="alert alert-info">No appointments available for {currentMonth}/{currentYear}</p>
            </f:else>
        </f:if>
        
        <br><br>
        
        <!-- Ð¡Ð»ÐµÐ´Ð²Ð°Ñ‰ Ð¼ÐµÑÐµÑ† -->
        <f:if condition="{nextMymonth}">
            <f:then>
                <ms:calendar month="{nextMonth}" year="{nextYear}" days="{nextDays}">
                    <div class="month-header">
                        <h2>{monthName} {year}</h2>
                    </div>
                    
                    <table class="calendar-table">
                        <thead>
                            <tr>
                                <th>Mo</th>
                                <th>Di</th>
                                <th>Mi</th>
                                <th>Do</th>
                                <th>Fr</th>
                                <th class="weekend">Sa</th>
                                <th class="weekend">So</th>
                            </tr>
                        </thead>
                        <tbody>
                            <f:for each="{calendar}" as="week">
                                <tr>
                                    <f:for each="{week}" as="cell">
                                        <td class="
                                            {f:if(condition: cell.hasData, then: 'has-data')}
                                            {f:if(condition: cell.isToday, then: ' today')}
                                            {f:if(condition: cell.isWeekend, then: ' weekend')}
                                            {f:if(condition: '{cell.day} == 0', then: ' empty')}
                                        ">
                                            <f:if condition="{cell.day}">
                                                <f:then>
                                                    <div class="day-cell">
                                                        <span class="day-number">{cell.day}</span>
                                                        
                                                        <f:if condition="{cell.hasData}">
                                                            <div class="events-list">
                                                                <f:for each="{cell.dayEvents}" as="event">
                                                                    <a href="#" 
                                                                       data-myday-uid="{event.uid}"
                                                                       class="event-link {f:if(condition: event.person, then: 'booked', else: 'available')}"
                                                                       title="{f:if(condition: event.person, then: 'Booked', else: 'Click to book')}">
                                                                        <span class="event-time">
                                                                            <f:if condition="{event.timeslot}">
                                                                                {event.timeslot}
                                                                            </f:if>
                                                                            <f:if condition="{event.timeslotend}">
                                                                                - {event.timeslotend}
                                                                            </f:if>
                                                                        </span>
                                                                        <span class="event-status">
                                                                            <f:if condition="{event.person}">
                                                                                <f:then>ðŸ”’ Booked</f:then>
                                                                                <f:else>âœ“ Available</f:else>
                                                                            </f:if>
                                                                        </span>
                                                                    </a>
                                                                </f:for>
                                                            </div>
                                                        </f:if>
                                                    </div>
                                                </f:then>
                                                <f:else>
                                                    <span class="empty-cell">&nbsp;</span>
                                                </f:else>
                                            </f:if>
                                        </td>
                                    </f:for>
                                </tr>
                            </f:for>
                        </tbody>
                    </table>
                </ms:calendar>
            </f:then>
            <f:else>
                <p class="alert alert-info">No appointments available for {nextMonth}/{nextYear}</p>
            </f:else>
        </f:if>
    </div>
    
	<script>
	// Open modal function (Bootstrap 4 compatible)
	function openEventModal(mydayUid) {
		console.log('Opening modal for UID:', mydayUid);
		
		// Get modal element
		var modalEl = document.getElementById('eventModal');
		var modalBody = document.getElementById('modalBody');
		var saveBtn = document.getElementById('saveBtn');
		
		// Show modal (Bootstrap 4 way)
		var $modal = window.jQuery ? jQuery(modalEl) : null;
		if ($modal) {
			$modal.modal('show');
		} else {
			modalEl.classList.add('show');
			modalEl.style.display = 'block';
			document.body.classList.add('modal-open');
			
			var backdrop = document.createElement('div');
			backdrop.className = 'modal-backdrop fade show';
			backdrop.id = 'modalBackdrop';
			document.body.appendChild(backdrop);
		}
		
		// Hide save button only if it exists
		if (saveBtn) {
			saveBtn.style.display = 'none';
		}
		
		// Show loading spinner
		modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>';
		
		// Build URL
		var url = window.location.pathname + 
			'?tx_monthlyschedule_publicbooking[action]=ajaxShow' +
			'&tx_monthlyschedule_publicbooking[controller]=Myday' +
			'&tx_monthlyschedule_publicbooking[myday]=' + mydayUid;
		
		console.log('AJAX URL:', url);
		
		// Fetch data
		fetch(url)
			.then(response => response.text())
			.then(html => {
				console.log('AJAX success, content length:', html.length);
				modalBody.innerHTML = html;
				
				if (saveBtn) {
					saveBtn.style.display = 'block';
				}
			})
			.catch(error => {
				console.error('AJAX error:', error);
				modalBody.innerHTML = '<div class="alert alert-danger">Error loading event details: ' + error + '</div>';
			});
	}

	// Helper function to close modal
	function closeModal() {
		var modalEl = document.getElementById('eventModal');
		var $modal = window.jQuery ? jQuery(modalEl) : null;
		
		if ($modal) {
			$modal.modal('hide');
		} else {
			modalEl.classList.remove('show');
			modalEl.style.display = 'none';
			document.body.classList.remove('modal-open');
			
			var backdrop = document.getElementById('modalBackdrop');
			if (backdrop) {
				backdrop.remove();
			}
		}
	}

	// All event handlers when DOM is ready
	document.addEventListener('DOMContentLoaded', function() {
		
		// Event delegation - handle clicks on event links
		document.addEventListener('click', function(e) {
			var target = e.target.closest('.event-link');
			if (target && target.hasAttribute('data-myday-uid')) {
				e.preventDefault();
				var mydayUid = target.getAttribute('data-myday-uid');
				openEventModal(mydayUid);
			}
		});
		
		// Note: No save button handler needed for public view
		// The booking form in AjaxShowPublic.html handles its own submission
	});
	</script>
    
	<!-- Bootstrap Modal -->
	<div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="eventModalLabel">Book Appointment</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body" id="modalBody">
					<div class="text-center">
						<div class="spinner-border" role="status">
							<span class="sr-only">Loading...</span>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>
    
</f:section>