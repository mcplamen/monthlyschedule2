{namespace ms=Mcplamen\Monthlyschedule\ViewHelpers}

<f:layout name="Default" />
<f:asset.css identifier="calendar-css" href="EXT:monthlyschedule/Resources/Public/Css/calendar.css" />

<f:section name="content">

<div class="calendar-wrapper public-booking">
    <h1 class="main-title">Book an Appointment</h1>
    <p class="subtitle">Select a date and time slot to book your appointment</p>

    <ms:calendar month="{currentMonth}" year="{currentYear}" days="{currentDays}">
        <div class="month-header">
            <h2>{monthName} {year}</h2>
        </div>

        <table class="calendar-table">
            <thead>
                <tr>
                    <th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th>
                    <th class="weekend">Sa</th><th class="weekend">So</th>
                </tr>
            </thead>
            <tbody>
                <f:for each="{calendar}" as="week">
                    <tr>
                        <f:for each="{week}" as="cell">
                            <td class="
                                {f:if(condition: cell.hasData, then: 'has-data')}
                                {f:if(condition: cell.isToday, then: ' today')}
                                {f:if(condition: cell.isWeekend, then: ' weekend')}
                                {f:if(condition: '{cell.day} == 0', then: ' empty')}
                            ">
                                <f:if condition="{cell.day}">
                                    <div class="day-cell">
                                        <span class="day-number">{cell.day}</span>

                                        <f:if condition="{cell.hasData}">
                                            <div class="events-list">
                                                <f:for each="{cell.dayEvents}" as="event">
                                                    <a href="#"
                                                       class="event-link {f:if(condition: event.person, then: 'booked', else: 'available')}"
                                                       data-myday-uid="{event.uid}">
                                                        <span class="event-time">
                                                            {event.timeslot} â€“ {event.timeslotend}
                                                        </span>
                                                        <span class="event-status">
                                                            <f:if condition="{event.person}">
                                                                ðŸ”’ Booked
                                                            <f:else>
                                                                âœ“ Available
                                                            </f:else>
                                                            </f:if>
                                                        </span>
                                                    </a>
                                                </f:for>
                                            </div>
                                        </f:if>
                                    </div>
                                </f:if>
                            </td>
                        </f:for>
                    </tr>
                </f:for>
            </tbody>
        </table>
    </ms:calendar>
</div>

<!-- ================= MODAL ================= -->

<div class="modal fade" id="eventModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Book Appointment</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>

            <div class="modal-body" id="modalBody">
                <div class="text-center">
                    <div class="spinner-border"></div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    Close
                </button>
            </div>

        </div>
    </div>
</div>

<!-- ================= SCRIPT ================= -->

<script>
function openEventModal(uid) {

    const modal = document.getElementById('eventModal');
    const body  = document.getElementById('modalBody');

    jQuery(modal).modal('show');

    body.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';

    fetch(
        window.location.pathname +
        '?tx_monthlyschedule_publicbooking[action]=ajaxShow' +
        '&tx_monthlyschedule_publicbooking[controller]=Myday' +
        '&tx_monthlyschedule_publicbooking[myday]=' + uid
    )
    .then(r => r.text())
    .then(html => body.innerHTML = html);
}

// open modal
document.addEventListener('click', function(e) {
    const link = e.target.closest('.event-link');
    if (!link) return;

    e.preventDefault();
    openEventModal(link.dataset.mydayUid);
});

// BOOK BUTTON (AJAX SAVE)
document.addEventListener('click', function(e) {
    if (e.target.id !== 'bookBtn') return;

    const form = document.getElementById('eventForm');
    const uid  = form.dataset.uid;

    const postData = new URLSearchParams();
	postData.append('tx_monthlyschedule_publicbooking[action]', 'publicBook');
	postData.append('tx_monthlyschedule_publicbooking[controller]', 'Myday');
	postData.append('tx_monthlyschedule_publicbooking[myday]', uid);
    postData.append('tx_monthlyschedule_publicbooking[data][person]', form.person.value);
    postData.append('tx_monthlyschedule_publicbooking[data][email]', form.email.value);
    postData.append('tx_monthlyschedule_publicbooking[data][topic]', form.topic.value);

    fetch(
        window.location.pathname +
        '?tx_monthlyschedule_publicbooking[action]=ajaxUpdate' +
        '&tx_monthlyschedule_publicbooking[controller]=Myday',
        {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: postData
        }
    )
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('modalBody').innerHTML =
                '<div class="alert alert-success text-center">' +
                '<h4>Booking successful</h4></div>';

            setTimeout(() => jQuery('#eventModal').modal('hide'), 800);
        }
    });
});
</script>

</f:section>
