<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers" data-namespace-typo3-fluid="true">

{namespace ms=Mcplamen\Monthlyschedule\ViewHelpers}

<f:layout name="Default" />

<f:section name="content">

    <div class="calendar-wrapper">
        <h1 class="main-title">Monthly Schedule</h1>
        
        <!-- Текущ месец -->
        <f:if condition="{currentMymonth}">
            <f:then>
                <ms:calendar month="{currentMonth}" year="{currentYear}" days="{currentDays}">
                    <div class="month-header">
                        <h2>{monthName} {year}</h2>
                        <div class="month-actions">
                            <f:link.action 
                                action="new" 
                                controller="Myday" 
                                arguments="{mymonth: currentMymonth.uid, monthNumber: currentMonth, year: currentYear}"
                                class="btn btn-success">
                                + Neue Tage
                            </f:link.action>
                        </div>
                    </div>
                    
                    <table class="calendar-table">
                        <thead>
                            <tr>
                                <th>Mo</th>
                                <th>Di</th>
                                <th>Mi</th>
                                <th>Do</th>
                                <th>Fr</th>
                                <th class="weekend">Sa</th>
                                <th class="weekend">So</th>
                            </tr>
                        </thead>
                        <tbody>
                            <f:for each="{calendar}" as="week">
                                <tr>
                                    <f:for each="{week}" as="cell">
                                        <td class="
                                            {f:if(condition: cell.hasData, then: 'has-data')}
                                            {f:if(condition: cell.isToday, then: ' today')}
                                            {f:if(condition: cell.isWeekend, then: ' weekend')}
                                            {f:if(condition: '{cell.day} == 0', then: ' empty')}
                                        ">
                                            <f:if condition="{cell.day}">
                                                <f:then>
                                                    <div class="day-cell">
                                                        <span class="day-number">{cell.day}</span>
                                                        
                                                        <f:if condition="{cell.hasData}">
                                                            <div class="events-list">
                                                                <f:for each="{cell.dayEvents}" as="event">
    <a href="#" 
       onclick="openEventModal({event.uid}); return false;"
       class="event-link"
       title="Click to view/edit details">
																		<span class="event-time">
																			<f:if condition="{event.timeslot}">
																				{event.timeslot}
																			</f:if>
																			<f:if condition="{event.timeslotend}">
																				- {event.timeslotend}
																			</f:if>
																		</span>
																		<f:if condition="{event.workshift}">
																			<span class="event-workshift">{event.workshift}</span>
																		</f:if>
                                                                    </а>
                                                                </f:for>
                                                            </div>
                                                        </f:if>
                                                    </div>
                                                </f:then>
                                                <f:else>
                                                    <span class="empty-cell">&nbsp;</span>
                                                </f:else>
                                            </f:if>
                                        </td>
                                    </f:for>
                                </tr>
                            </f:for>
                        </tbody>
                    </table>
                </ms:calendar>
            </f:then>
            <f:else>
                <p>Keine Daten für {currentMonth}/{currentYear}</p>
            </f:else>
        </f:if>
        
        <br><br>
        
        <!-- Следващ месец -->
        <f:if condition="{nextMymonth}">
            <f:then>
                <ms:calendar month="{nextMonth}" year="{nextYear}" days="{nextDays}">
                    <div class="month-header">
                        <h2>{monthName} {year}</h2>
                        <div class="month-actions">
                            <f:link.action 
                                action="new" 
                                controller="Myday" 
                                arguments="{mymonth: nextMymonth.uid, monthNumber: nextMonth, year: nextYear}"
                                class="btn btn-success">
                                + Neue Tage
                            </f:link.action>
                        </div>
                    </div>
                    
                    <table class="calendar-table">
                        <thead>
                            <tr>
                                <th>Mo</th>
                                <th>Di</th>
                                <th>Mi</th>
                                <th>Do</th>
                                <th>Fr</th>
                                <th class="weekend">Sa</th>
                                <th class="weekend">So</th>
                            </tr>
                        </thead>
                        <tbody>
                            <f:for each="{calendar}" as="week">
                                <tr>
                                    <f:for each="{week}" as="cell">
                                        <td class="
                                            {f:if(condition: cell.hasData, then: 'has-data')}
                                            {f:if(condition: cell.isToday, then: ' today')}
                                            {f:if(condition: cell.isWeekend, then: ' weekend')}
                                            {f:if(condition: '{cell.day} == 0', then: ' empty')}
                                        ">
                                            <f:if condition="{cell.day}">
                                                <f:then>
                                                    <div class="day-cell">
                                                        <span class="day-number">{cell.day}</span>
                                                        
                                                        <f:if condition="{cell.hasData}">
                                                            <div class="events-list">
                                                                <f:for each="{cell.dayEvents}" as="event">
    <a href="#" 
       onclick="openEventModal({event.uid}); return false;"
       class="event-link"
       title="Click to view/edit details">
                                                                        <span class="event-time">
                                                                            <f:if condition="{event.starttime}">
                                                                                {event.starttime}
                                                                            </f:if>
                                                                            <f:if condition="{event.endtime}">
                                                                                - {event.endtime}
                                                                            </f:if>
                                                                        </span>
                                                                        <f:if condition="{event.workshift}">
                                                                            <span class="event-workshift">{event.workshift}</span>
                                                                        </f:if>
                                                                    </а>
                                                                </f:for>
                                                            </div>
                                                        </f:if>
                                                    </div>
                                                </f:then>
                                                <f:else>
                                                    <span class="empty-cell">&nbsp;</span>
                                                </f:else>
                                            </f:if>
                                        </td>
                                    </f:for>
                                </tr>
                            </f:for>
                        </tbody>
                    </table>
                </ms:calendar>
            </f:then>
            <f:else>
                <p>Keine Daten für {nextMonth}/{nextYear}</p>
            </f:else>
        </f:if>
    </div>
    
    <hr>
    
	<!-- Bootstrap Modal за показване/редакция на събитие -->
<div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Event Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                
				 
				<f:if condition="{isAdmin}">
					<button type="button" class="btn btn-primary" id="saveBtn" style="display:none;">Save</button>
				</f:if>
            </div>
        </div>
    </div>
</div>

<script>
// Open modal function (Bootstrap 4 compatible)
function openEventModal(mydayUid) {
    console.log('Opening modal for UID:', mydayUid);
    
    // Get modal element
    var modalEl = document.getElementById('eventModal');
    var modalBody = document.getElementById('modalBody');
    var saveBtn = document.getElementById('saveBtn');
    
    // Show modal (Bootstrap 4 way - using jQuery that Bootstrap 4 requires)
    var $modal = window.jQuery ? jQuery(modalEl) : null;
    if ($modal) {
        $modal.modal('show');
    } else {
        // Fallback if jQuery not available
        modalEl.classList.add('show');
        modalEl.style.display = 'block';
        document.body.classList.add('modal-open');
        
        // Add backdrop
        var backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'modalBackdrop';
        document.body.appendChild(backdrop);
    }
    
    // Hide save button only if it exists
    if (saveBtn) {
        saveBtn.style.display = 'none';
    }
    
    // Show loading spinner
    modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>';
    
    // Build URL
    var url = window.location.pathname + 
        '?tx_monthlyschedule_monthlyschedule[action]=ajaxShow' +
        '&tx_monthlyschedule_monthlyschedule[controller]=Myday' +
        '&tx_monthlyschedule_monthlyschedule[myday]=' + mydayUid;
    
    console.log('AJAX URL:', url);
    
    // Fetch data
    fetch(url)
        .then(response => response.text())
        .then(html => {
            console.log('AJAX success, content length:', html.length);
            modalBody.innerHTML = html;
            
            // Show save button only if it exists
            if (saveBtn) {
                saveBtn.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('AJAX error:', error);
            modalBody.innerHTML = '<div class="alert alert-danger">Error loading event details: ' + error + '</div>';
        });
}

// Helper function to close modal (Bootstrap 4)
function closeModal() {
    var modalEl = document.getElementById('eventModal');
    var $modal = window.jQuery ? jQuery(modalEl) : null;
    
    if ($modal) {
        $modal.modal('hide');
    } else {
        // Manual close
        modalEl.classList.remove('show');
        modalEl.style.display = 'none';
        document.body.classList.remove('modal-open');
        
        // Remove backdrop
        var backdrop = document.getElementById('modalBackdrop');
        if (backdrop) {
            backdrop.remove();
        }
    }
}

// All event handlers when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    
    // Event delegation - handle clicks on event links
    document.addEventListener('click', function(e) {
        var target = e.target.closest('.event-link');
        if (target && target.hasAttribute('data-myday-uid')) {
            e.preventDefault();
            var mydayUid = target.getAttribute('data-myday-uid');
            openEventModal(mydayUid);
        }
    });
    
    // Save button handler
    var saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
        saveBtn.addEventListener('click', function() {
            console.log('Save button clicked');
            
            var form = document.getElementById('eventForm');
            if (!form) {
                console.error('Form not found');
                return;
            }
            
            var uid = form.getAttribute('data-uid');
            console.log('Form UID:', uid);
            
            // Get form inputs
            var personInput = form.querySelector('[name="person"]');
            var emailInput = form.querySelector('[name="email"]');
            var topicInput = form.querySelector('[name="topic"]');
            
            if (!personInput || !emailInput || !topicInput) {
                console.error('Form inputs not found');
                return;
            }
            
            // Get form data
            var formData = {
                person: personInput.value,
                email: emailInput.value,
                topic: topicInput.value,
                confirm: form.querySelector('[name="confirm"]') ? form.querySelector('[name="confirm"]').checked : false
            };
            
            console.log('Saving data:', formData);
            
            // Disable save button
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            
            // Build POST data
            var postData = new URLSearchParams();
            postData.append('tx_monthlyschedule_monthlyschedule[action]', 'ajaxUpdate');
            postData.append('tx_monthlyschedule_monthlyschedule[controller]', 'Myday');
            postData.append('tx_monthlyschedule_monthlyschedule[myday]', uid);
            postData.append('tx_monthlyschedule_monthlyschedule[data][person]', formData.person);
            postData.append('tx_monthlyschedule_monthlyschedule[data][email]', formData.email);
            postData.append('tx_monthlyschedule_monthlyschedule[data][topic]', formData.topic);
            postData.append('tx_monthlyschedule_monthlyschedule[data][confirm]', formData.confirm);
            
            console.log('POST data:', postData.toString());
            
            // AJAX save
            fetch(window.location.pathname, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: postData
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.text();
            })
            .then(text => {
                console.log('Raw response:', text);
                
                try {
                    var data = JSON.parse(text);
                    console.log('Parsed data:', data);
                    
                    if(data.success) {
                        var modalBody = document.getElementById('modalBody');
                        modalBody.innerHTML = '<div class="alert alert-success text-center"><h4>Saved successfully!</h4><p>Reloading...</p></div>';
                        
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        console.error('Save failed:', data.message);
                        document.getElementById('modalBody').insertAdjacentHTML('afterbegin', '<div class="alert alert-danger">Error: ' + (data.message || 'Unknown error') + '</div>');
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Save';
                    }
                } catch(e) {
                    console.error('JSON parse error:', e);
                    console.log('Response text:', text);
                    document.getElementById('modalBody').insertAdjacentHTML('afterbegin', '<div class="alert alert-danger">Server error: Invalid response</div>');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                document.getElementById('modalBody').insertAdjacentHTML('afterbegin', '<div class="alert alert-danger">Error: ' + error + '</div>');
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save';
            });
        });
    }
});
</script>
	
</f:section>
</html>
