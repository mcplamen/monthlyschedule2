<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers" data-namespace-typo3-fluid="true">

{namespace ms=Mcplamen\Monthlyschedule\ViewHelpers}

<f:layout name="Default" />

<f:section name="content">

    <f:if condition="{isAdmin}">
        <f:else>
            <div style="background: #ffcc00; color: #000; padding: 15px; border: 3px solid #cc9900; border-radius: 6px; font-size: 18px; font-weight: bold; margin-bottom: 25px; text-align: center; box-shadow: 0 0 12px rgba(0,0,0,0.25);">
                ⚠️ Achtung! Sie sind nicht eingeloggt, um die Funktionen des Programms zu nutzen.
            </div>
        </f:else>
    </f:if>

    <div class="calendar-wrapper">
        <h1 class="main-title">Monthly Schedule</h1>
        
        <!-- Legend за цветовете -->
        <div class="calendar-legend">
            <span class="legend-item">
                <span class="legend-color" style="background: #27ae60;"></span> Verfügbar (Available)
            </span>
            <span class="legend-item">
                <span class="legend-color" style="background: #f39c12;"></span> Gebucht (Booked)
            </span>
            <span class="legend-item">
                <span class="legend-color" style="background: #e74c3c;"></span> Bestätigt (Confirmed)
            </span>
        </div>
        
        <!-- Текущ месец -->
        <f:if condition="{currentMymonth}">
            <f:then>
                <ms:calendar month="{currentMonth}" year="{currentYear}" days="{currentDays}">
                    <div class="month-header">
                        <h2>{monthName} {year}</h2>
                        <div class="month-actions">
                            <f:link.action 
                                action="new" 
                                controller="Myday" 
                                arguments="{mymonth: currentMymonth.uid, monthNumber: currentMonth, year: currentYear}"
                                class="btn btn-success">
                                + Neue Tage
                            </f:link.action>
                        </div>
                    </div>
                    
                    <table class="calendar-table">
                        <thead>
                            <tr>
                                <th>Mo</th>
                                <th>Di</th>
                                <th>Mi</th>
                                <th>Do</th>
                                <th>Fr</th>
                                <th class="weekend">Sa</th>
                                <th class="weekend">So</th>
                            </tr>
                        </thead>
                        <tbody>
                            <f:for each="{calendar}" as="week">
                                <tr>
                                    <f:for each="{week}" as="cell">
                                        <td class="
                                            {f:if(condition: cell.hasData, then: 'has-data')}
                                            {f:if(condition: cell.isToday, then: ' today')}
                                            {f:if(condition: cell.isWeekend, then: ' weekend')}
                                            {f:if(condition: '{cell.day} == 0', then: ' empty')}
                                        ">
                                            <f:if condition="{cell.day}">
                                                <f:then>
                                                    <div class="day-cell">
                                                        <span class="day-number">{cell.day}</span>
                                                        
                                                        <f:if condition="{cell.hasData}">
                                                            <div class="events-list">
                                                                <f:for each="{cell.dayEvents}" as="event">
                                                                    <f:comment>Използваме event.status от CalendarViewHelper</f:comment>
                                                                    <a href="#" 
                                                                       onclick="openEventModal({event.uid}); return false;"
                                                                       class="event-link status-{event.status}"
                                                                       title="Click to view/edit details">
                                                                        <span class="event-time">
                                                                            <f:if condition="{event.timeslot}">
                                                                                {event.timeslot}
                                                                            </f:if>
                                                                            <f:if condition="{event.timeslotend}">
                                                                                - {event.timeslotend}
                                                                            </f:if>
                                                                        </span>
                                                                        <f:comment>Показваме person ако има</f:comment>
                                                                        <f:if condition="{event.person}">
                                                                            <span class="event-person">{event.person}</span>
                                                                        </f:if>
                                                                    </a>
                                                                </f:for>
                                                            </div>
                                                        </f:if>
                                                    </div>
                                                </f:then>
                                                <f:else>
                                                    <span class="empty-cell">&nbsp;</span>
                                                </f:else>
                                            </f:if>
                                        </td>
                                    </f:for>
                                </tr>
                            </f:for>
                        </tbody>
                    </table>
                </ms:calendar>
            </f:then>
            <f:else>
                <p>Keine Daten für {currentMonth}/{currentYear}</p>
            </f:else>
        </f:if>
        
        <br><br>
        
        <!-- Следващ месец -->
        <f:if condition="{nextMymonth}">
            <f:then>
                <ms:calendar month="{nextMonth}" year="{nextYear}" days="{nextDays}">
                    <div class="month-header">
                        <h2>{monthName} {year}</h2>
                        <div class="month-actions">
                            <f:link.action 
                                action="new" 
                                controller="Myday" 
                                arguments="{mymonth: nextMymonth.uid, monthNumber: nextMonth, year: nextYear}"
                                class="btn btn-success">
                                + Neue Tage
                            </f:link.action>
                        </div>
                    </div>
                    
                    <table class="calendar-table">
                        <thead>
                            <tr>
                                <th>Mo</th>
                                <th>Di</th>
                                <th>Mi</th>
                                <th>Do</th>
                                <th>Fr</th>
                                <th class="weekend">Sa</th>
                                <th class="weekend">So</th>
                            </tr>
                        </thead>
                        <tbody>
                            <f:for each="{calendar}" as="week">
                                <tr>
                                    <f:for each="{week}" as="cell">
                                        <td class="
                                            {f:if(condition: cell.hasData, then: 'has-data')}
                                            {f:if(condition: cell.isToday, then: ' today')}
                                            {f:if(condition: cell.isWeekend, then: ' weekend')}
                                            {f:if(condition: '{cell.day} == 0', then: ' empty')}
                                        ">
                                            <f:if condition="{cell.day}">
                                                <f:then>
                                                    <div class="day-cell">
                                                        <span class="day-number">{cell.day}</span>
                                                        
                                                        <f:if condition="{cell.hasData}">
                                                            <div class="events-list">
                                                                <f:for each="{cell.dayEvents}" as="event">
                                                                    <a href="#" 
                                                                       onclick="openEventModal({event.uid}); return false;"
                                                                       class="event-link status-{event.status}"
                                                                       title="Click to view/edit details">
                                                                        <span class="event-time">
                                                                            <f:if condition="{event.timeslot}">
                                                                                {event.timeslot}
                                                                            </f:if>
                                                                            <f:if condition="{event.timeslotend}">
                                                                                - {event.timeslotend}
                                                                            </f:if>
                                                                        </span>
                                                                        <f:if condition="{event.person}">
                                                                            <span class="event-person">{event.person}</span>
                                                                        </f:if>
                                                                    </a>
                                                                </f:for>
                                                            </div>
                                                        </f:if>
                                                    </div>
                                                </f:then>
                                                <f:else>
                                                    <span class="empty-cell">&nbsp;</span>
                                                </f:else>
                                            </f:if>
                                        </td>
                                    </f:for>
                                </tr>
                            </f:for>
                        </tbody>
                    </table>
                </ms:calendar>
            </f:then>
            <f:else>
                <p>Keine Daten für {nextMonth}/{nextYear}</p>
            </f:else>
        </f:if>
    </div>
    
    <hr>
    
    <!-- Bootstrap Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1" role="dialog" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">Event Details</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="modalBody">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <f:if condition="{isAdmin}">
                        <button type="button" class="btn btn-primary" id="saveBtn" style="display:none;">Save</button>
                    </f:if>
                </div>
            </div>
        </div>
    </div>

    <script>
    function openEventModal(mydayUid) {
        var modalEl = document.getElementById('eventModal');
        var modalBody = document.getElementById('modalBody');
        var saveBtn = document.getElementById('saveBtn');

        var $modal = window.jQuery ? jQuery(modalEl) : null;
        if ($modal) {
            $modal.modal('show');
        } else {
            modalEl.classList.add('show');
            modalEl.style.display = 'block';
            document.body.classList.add('modal-open');
            var backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = 'modalBackdrop';
            document.body.appendChild(backdrop);
        }

        if (saveBtn) {
            saveBtn.style.display = 'none';
        }

        modalBody.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>';

        var url = window.location.pathname +
            '?tx_monthlyschedule_monthlyschedule[action]=ajaxShow' +
            '&tx_monthlyschedule_monthlyschedule[controller]=Myday' +
            '&tx_monthlyschedule_monthlyschedule[myday]=' + mydayUid;

        fetch(url)
            .then(response => response.text())
            .then(html => {
                modalBody.innerHTML = html;
                if (saveBtn) {
                    saveBtn.style.display = 'block';
                }
            })
            .catch(() => {
                modalBody.innerHTML = '<div class="alert alert-danger">Error loading event details</div>';
            });
    }

    function closeModal() {
        var modalEl = document.getElementById('eventModal');
        var $modal = window.jQuery ? jQuery(modalEl) : null;
        if ($modal) {
            $modal.modal('hide');
        } else {
            modalEl.classList.remove('show');
            modalEl.style.display = 'none';
            document.body.classList.remove('modal-open');
            var backdrop = document.getElementById('modalBackdrop');
            if (backdrop) {
                backdrop.remove();
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.addEventListener('click', function(e) {
            var target = e.target.closest('.event-link');
            if (target && target.dataset.mydayUid) {
                e.preventDefault();
                openEventModal(target.dataset.mydayUid);
            }
        });

        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'saveBtn') {
                var form = document.getElementById('eventForm');
                if (!form) return;

                var uid = form.dataset.uid;
                var personInput = form.querySelector('[name="person"]');
                var emailInput = form.querySelector('[name="email"]');
                var topicInput = form.querySelector('[name="topic"]');

                if (!personInput || !emailInput || !topicInput) return;

                e.target.disabled = true;
                e.target.textContent = 'Saving...';

                var postData = new URLSearchParams();
                postData.append('tx_monthlyschedule_monthlyschedule[action]', 'ajaxUpdate');
                postData.append('tx_monthlyschedule_monthlyschedule[controller]', 'Myday');
                postData.append('tx_monthlyschedule_monthlyschedule[myday]', uid);
                postData.append('tx_monthlyschedule_monthlyschedule[data][person]', personInput.value);
                postData.append('tx_monthlyschedule_monthlyschedule[data][email]', emailInput.value);
                postData.append('tx_monthlyschedule_monthlyschedule[data][topic]', topicInput.value);
                postData.append('tx_monthlyschedule_monthlyschedule[data][confirm]', form.querySelector('[name="confirm"]')?.checked ? 1 : 0);

                var saveUrl = window.location.pathname + '?tx_monthlyschedule_monthlyschedule[action]=ajaxUpdate&tx_monthlyschedule_monthlyschedule[controller]=Myday';

                fetch(saveUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: postData
                })
                .then(response => response.text())
                .then(text => {
                    var data = JSON.parse(text);
                    if (data.success) {
                        document.getElementById('modalBody').innerHTML = '<div class="alert alert-success text-center"><h4>Saved successfully!</h4></div>';
                        setTimeout(function() {
                            closeModal();
                            location.reload();
                        }, 500);
                    } else {
                        throw new Error(data.message || 'Save failed');
                    }
                })
                .catch(() => {
                    document.getElementById('modalBody').insertAdjacentHTML('afterbegin', '<div class="alert alert-danger">Save failed</div>');
                    e.target.disabled = false;
                    e.target.textContent = 'Save';
                });
            }
        });
    });
    </script>
    
    <style>
    .calendar-legend {
        display: flex;
        gap: 20px;
        margin: 15px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
    }
    .legend-color {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: inline-block;
        border: 2px solid rgba(0,0,0,0.1);
    }
    .event-person {
        font-size: 9px;
        opacity: 0.9;
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 100%;
    }
    </style>
    
</f:section>
</html>